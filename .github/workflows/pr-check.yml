# =============================================================================
# StockFlow PR Check Pipeline
# =============================================================================
# Automated checks for pull requests including validation and security scanning.
# =============================================================================

name: PR Check

on:
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened

env:
  NODE_VERSION: '20'
  WORKING_DIRECTORY: ./server

jobs:
  # ===========================================================================
  # PR Validation
  # ===========================================================================
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            build
            ci
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" does not match the expected format.
            - Must start with a capital letter
            - Example: "feat: Add user authentication"

      - name: Check for breaking changes
        run: |
          # Check if PR contains breaking changes in commit messages
          if git log --oneline origin/${{ github.base_ref }}..HEAD | grep -qi "BREAKING CHANGE\|!:"; then
            echo "::warning::This PR contains breaking changes. Ensure proper documentation and migration guides are included."
          fi

  # ===========================================================================
  # Dependency Check
  # ===========================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./server
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

  # ===========================================================================
  # Type Check
  # ===========================================================================
  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run TypeScript compiler
        run: npx tsc --noEmit

  # ===========================================================================
  # Test Coverage Comparison
  # ===========================================================================
  coverage-comparison:
    name: Coverage Comparison
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: stockflow_test
          POSTGRES_PASSWORD: stockflow_test_password
          POSTGRES_DB: stockflow_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://stockflow_test:stockflow_test_password@localhost:5432/stockflow_test
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      JWT_SECRET: test-jwt-secret-for-ci
      JWT_REFRESH_SECRET: test-jwt-refresh-secret-for-ci
      NODE_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy

      - name: Run tests with coverage
        run: npm run test:cov -- --coverageReporters=json-summary

      - name: Report coverage
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          working-directory: server
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
        continue-on-error: true