generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
  TRIAL
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  EMPLOYEE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum WarehouseStatus {
  ACTIVE
  INACTIVE
}

enum MovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  RETURN
  DAMAGED
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

enum DocumentType {
  CC
  NIT
  RUT
  PASSPORT
  CE
  DNI
  OTHER
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  OVERDUE
  CANCELLED
  VOID
}

enum PaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  PSE
  NEQUI
  DAVIPLATA
  OTHER
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum SystemAdminRole {
  SUPER_ADMIN
  SUPPORT
  BILLING
}

enum SystemAdminStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum AuthProvider {
  EMAIL
  GOOGLE
  GITHUB
}

// ============================================================================
// MODELS
// ============================================================================

model Tenant {
  id                     String           @id @default(cuid())
  name                   String
  slug                   String           @unique
  email                  String
  phone                  String?
  status                 TenantStatus     @default(TRIAL)
  plan                   SubscriptionPlan @default(FREE)
  stripeCustomerId       String?          @map("stripe_customer_id")
  stripeSubscriptionId   String?          @map("stripe_subscription_id")
  maxUsers               Int              @default(5) @map("max_users")
  maxProducts            Int              @default(-1) @map("max_products")
  maxInvoices            Int              @default(-1) @map("max_invoices")
  maxWarehouses          Int              @default(1) @map("max_warehouses")
  createdAt              DateTime         @default(now()) @map("created_at")
  updatedAt              DateTime         @updatedAt @map("updated_at")

  users       User[]
  products    Product[]
  customers   Customer[]
  invoices    Invoice[]
  warehouses  Warehouse[]
  categories  Category[]
  movements   StockMovement[]
  payments    Payment[]
  auditLogs   AuditLog[]
  invitations Invitation[]

  @@map("tenants")
}

model User {
  id                       String     @id @default(cuid())
  tenantId                 String     @map("tenant_id")
  email                    String
  password                 String
  firstName                String     @map("first_name")
  lastName                 String     @map("last_name")
  phone                    String?
  avatar                   String?
  googleId                 String?       @unique @map("google_id")
  githubId                 String?       @unique @map("github_id")
  authProvider             AuthProvider  @default(EMAIL) @map("auth_provider")
  role                     UserRole   @default(EMPLOYEE)
  status                   UserStatus @default(PENDING)
  emailVerified            Boolean    @default(false) @map("email_verified")
  verificationToken        String?    @unique @map("verification_token")
  verificationTokenExpiry  DateTime?  @map("verification_token_expiry")
  refreshToken             String?    @map("refresh_token")
  resetToken               String?    @map("reset_token")
  resetTokenExpiry         DateTime?  @map("reset_token_expiry")
  createdAt                DateTime   @default(now()) @map("created_at")
  updatedAt                DateTime   @updatedAt @map("updated_at")
  lastLoginAt              DateTime?  @map("last_login_at")

  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices    Invoice[]
  movements   StockMovement[]
  auditLogs   AuditLog[]
  invitations Invitation[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model Category {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  color       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([tenantId, name])
  @@map("categories")
}

model Product {
  id          String        @id @default(cuid())
  tenantId    String        @map("tenant_id")
  categoryId  String?       @map("category_id")
  sku         String
  name        String
  description String?
  costPrice   Decimal       @default(0) @map("cost_price") @db.Decimal(10, 2)
  salePrice   Decimal       @default(0) @map("sale_price") @db.Decimal(10, 2)
  taxRate     Decimal       @default(19) @map("tax_rate") @db.Decimal(5, 2)
  stock       Int           @default(0)
  minStock    Int           @default(0) @map("min_stock")
  maxStock    Int?          @map("max_stock")
  barcode     String?
  brand       String?
  unit        String        @default("unit")
  imageUrl    String?       @map("image_url")
  status      ProductStatus @default(ACTIVE)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category       Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  invoiceItems   InvoiceItem[]
  movements      StockMovement[]
  warehouseStock WarehouseStock[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, categoryId])
  @@map("products")
}

model Warehouse {
  id        String          @id @default(cuid())
  tenantId  String          @map("tenant_id")
  name      String
  code      String
  address   String?
  city      String?
  phone     String?
  isMain    Boolean         @default(false) @map("is_main")
  status    WarehouseStatus @default(ACTIVE)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stocks    WarehouseStock[]
  movements StockMovement[]

  @@unique([tenantId, code])
  @@map("warehouses")
}

model WarehouseStock {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  warehouseId String   @map("warehouse_id")
  productId   String   @map("product_id")
  quantity    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, productId])
  @@index([tenantId])
  @@index([productId])
  @@map("warehouse_stocks")
}

model StockMovement {
  id          String       @id @default(cuid())
  tenantId    String       @map("tenant_id")
  productId   String       @map("product_id")
  warehouseId String?      @map("warehouse_id")
  userId      String?      @map("user_id")
  type        MovementType
  quantity    Int
  reason      String?
  notes       String?
  invoiceId   String?      @map("invoice_id")
  createdAt   DateTime     @default(now()) @map("created_at")

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  user      User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([productId])
  @@index([warehouseId])
  @@map("stock_movements")
}

model Customer {
  id             String         @id @default(cuid())
  tenantId       String         @map("tenant_id")
  name           String
  email          String?
  phone          String?
  documentType   DocumentType   @default(CC) @map("document_type")
  documentNumber String         @map("document_number")
  address        String?
  city           String?
  state          String?
  businessName   String?        @map("business_name")
  taxId          String?        @map("tax_id")
  notes          String?
  status         CustomerStatus @default(ACTIVE)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@unique([tenantId, documentNumber])
  @@index([tenantId, name])
  @@map("customers")
}

model Invoice {
  id            String        @id @default(cuid())
  tenantId      String        @map("tenant_id")
  customerId    String?       @map("customer_id")
  userId        String?       @map("user_id")
  invoiceNumber String        @map("invoice_number")
  subtotal      Decimal       @default(0) @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @default(0) @db.Decimal(10, 2)
  issueDate     DateTime      @default(now()) @map("issue_date")
  dueDate       DateTime?     @map("due_date")
  status        InvoiceStatus @default(DRAFT)
  paymentStatus PaymentStatus @default(UNPAID) @map("payment_status")
  notes         String?
  dianCufe      String?       @map("dian_cufe")
  dianXml       String?       @map("dian_xml")
  dianPdf       String?       @map("dian_pdf")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  user     User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  items    InvoiceItem[]
  payments Payment[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([tenantId, status])
  @@map("invoices")
}

model InvoiceItem {
  id        String   @id @default(cuid())
  invoiceId String   @map("invoice_id")
  productId String?  @map("product_id")
  quantity  Int      @default(1)
  unitPrice Decimal  @default(0) @map("unit_price") @db.Decimal(10, 2)
  taxRate   Decimal  @default(19) @map("tax_rate") @db.Decimal(5, 2)
  discount  Decimal  @default(0) @db.Decimal(10, 2)
  subtotal  Decimal  @default(0) @db.Decimal(10, 2)
  tax       Decimal  @default(0) @db.Decimal(10, 2)
  total     Decimal  @default(0) @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@map("invoice_items")
}

model Payment {
  id          String        @id @default(cuid())
  tenantId    String        @map("tenant_id")
  invoiceId   String        @map("invoice_id")
  amount      Decimal       @db.Decimal(10, 2)
  method      PaymentMethod @default(CASH)
  reference   String?
  notes       String?
  paymentDate DateTime      @default(now()) @map("payment_date")
  createdAt   DateTime      @default(now()) @map("created_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([invoiceId])
  @@map("payments")
}

model AuditLog {
  id         String      @id @default(cuid())
  tenantId   String      @map("tenant_id")
  userId     String?     @map("user_id")
  action     AuditAction
  entityType String      @map("entity_type")
  entityId   String      @map("entity_id")
  oldValues  Json?       @map("old_values")
  newValues  Json?       @map("new_values")
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  metadata   Json?
  createdAt  DateTime    @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

model Invitation {
  id          String           @id @default(uuid())
  email       String
  tenantId    String           @map("tenant_id")
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role        UserRole         @default(EMPLOYEE)
  token       String           @unique
  expiresAt   DateTime         @map("expires_at")
  invitedById String           @map("invited_by_id")
  invitedBy   User             @relation(fields: [invitedById], references: [id])
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime         @default(now()) @map("created_at")
  acceptedAt  DateTime?        @map("accepted_at")

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([token])
  @@index([status])
  @@map("invitations")
}

// ============================================================================
// SYSTEM ADMIN MODELS (Separate from tenant users)
// ============================================================================

model SystemAdmin {
  id           String            @id @default(cuid())
  email        String            @unique
  password     String
  firstName    String            @map("first_name")
  lastName     String            @map("last_name")
  role         SystemAdminRole   @default(SUPPORT)
  status       SystemAdminStatus @default(ACTIVE)
  refreshToken String?           @map("refresh_token")
  lastLoginAt  DateTime?         @map("last_login_at")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  auditLogs SystemAdminAuditLog[]

  @@index([email])
  @@index([status])
  @@map("system_admins")
}

model SystemAdminAuditLog {
  id         String   @id @default(cuid())
  adminId    String   @map("admin_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  admin SystemAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("system_admin_audit_logs")
}