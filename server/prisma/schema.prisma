generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
  TRIAL
}

enum SubscriptionPlan {
  EMPRENDEDOR
  PYME
  PRO
  PLUS
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  CANCELLED
}

enum SubscriptionPeriod {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  EMPLOYEE
  CONTADOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum TaxCategory {
  GRAVADO_19
  GRAVADO_5
  EXENTO
  EXCLUIDO
}

enum WarehouseStatus {
  ACTIVE
  INACTIVE
}

enum MovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  RETURN
  DAMAGED
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

enum DocumentType {
  CC
  NIT
  RUT
  PASSPORT
  CE
  DNI
  OTHER
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  OVERDUE
  CANCELLED
  VOID
}

enum PaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  PSE
  NEQUI
  DAVIPLATA
  OTHER
}

enum InvoiceSource {
  MANUAL
  POS
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum SystemAdminRole {
  SUPER_ADMIN
  SUPPORT
  BILLING
}

enum SystemAdminStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum AuthProvider {
  EMAIL
  GOOGLE
  GITHUB
}

// POS Enums
enum CashRegisterStatus {
  OPEN
  CLOSED
  SUSPENDED
}

enum POSSessionStatus {
  ACTIVE
  CLOSED
  SUSPENDED
}

enum CashMovementType {
  OPENING
  CLOSING
  SALE
  REFUND
  CASH_IN
  CASH_OUT
}

// DIAN Enums
enum DianDocumentType {
  FACTURA_ELECTRONICA
  NOTA_CREDITO
  NOTA_DEBITO
}

enum CreditNoteReason {
  DEVOLUCION_PARCIAL
  ANULACION
  DESCUENTO
  AJUSTE_PRECIO
  OTRO
}

enum DebitNoteReason {
  INTERESES
  GASTOS
  CAMBIO_VALOR
  OTRO
}

// Payroll Enums
enum ContractType {
  TERMINO_FIJO
  TERMINO_INDEFINIDO
  OBRA_O_LABOR
  PRESTACION_SERVICIOS
}

enum SalaryType {
  ORDINARIO
  INTEGRAL
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

enum ARLRiskLevel {
  LEVEL_I   // 0.522%
  LEVEL_II  // 1.044%
  LEVEL_III // 2.436%
  LEVEL_IV  // 4.350%
  LEVEL_V   // 6.960%
}

enum PayrollPeriodType {
  MONTHLY
  BIWEEKLY
}

enum PayrollPeriodStatus {
  OPEN
  CALCULATING
  CALCULATED
  APPROVED
  SENT_TO_DIAN
  CLOSED
}

enum PayrollEntryStatus {
  DRAFT
  CALCULATED
  APPROVED
  SENT
  ACCEPTED
  REJECTED
}

enum OvertimeType {
  HED   // Hora extra diurna 1.25x
  HEN   // Hora extra nocturna 1.75x
  HDD   // Hora dominical/festiva diurna 2.0x
  HDN   // Hora dominical/festiva nocturna 2.5x
  HEDDF // Hora extra dominical/festiva diurna 2.5x
  HENDF // Hora extra nocturna dominical/festiva 2.75x
}

enum PayrollDocumentType {
  NOMINA_INDIVIDUAL
  NOMINA_AJUSTE
}

enum DianDocumentStatus {
  PENDING
  GENERATED
  SIGNED
  SENT
  ACCEPTED
  REJECTED
  ERROR
}

enum TaxResponsibility {
  O_13 // Gran contribuyente
  O_15 // Autoretenedor
  O_23 // Agente de retencion IVA
  O_47 // Regimen simple
  R_99_PN // No responsable (persona natural)
}

enum BillingStatus {
  PENDING
  APPROVED
  DECLINED
  VOIDED
  ERROR
}

enum NotificationType {
  LOW_STOCK
  OUT_OF_STOCK
  NEW_INVOICE
  INVOICE_PAID
  INVOICE_OVERDUE
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  NEW_CUSTOMER
  REPORT_READY
  SYSTEM
  INFO
  USER_VERIFIED_EMAIL
  USER_APPROVED
  SUBSCRIPTION_EXPIRING
  SUBSCRIPTION_EXPIRED
  SUBSCRIPTION_ACTIVATED
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================================================
// MODELS
// ============================================================================

model Tenant {
  id                     String            @id @default(cuid())
  name                   String
  slug                   String            @unique
  email                  String
  phone                  String?
  status                 TenantStatus      @default(TRIAL)
  plan                   SubscriptionPlan?
  wompiPaymentSourceId   String?           @map("wompi_payment_source_id")
  wompiCustomerEmail     String?           @map("wompi_customer_email")
  maxUsers               Int               @default(1) @map("max_users")
  maxProducts            Int               @default(100) @map("max_products")
  maxInvoices            Int               @default(50) @map("max_invoices")
  maxWarehouses          Int               @default(1) @map("max_warehouses")
  maxEmployees           Int               @default(10) @map("max_employees")
  createdAt              DateTime          @default(now()) @map("created_at")
  updatedAt              DateTime          @updatedAt @map("updated_at")

  users                 User[]
  products              Product[]
  customers             Customer[]
  invoices              Invoice[]
  warehouses            Warehouse[]
  categories            Category[]
  movements             StockMovement[]
  payments              Payment[]
  auditLogs             AuditLog[]
  invitations           Invitation[]
  notifications         Notification[]
  subscription          Subscription?
  cashRegisters         CashRegister[]
  posSessions           POSSession[]
  posSales              POSSale[]
  cashRegisterMovements CashRegisterMovement[]
  dianConfig            TenantDianConfig?
  dianDocuments         DianDocument[]
  billingTransactions   BillingTransaction[]
  quotations            Quotation[]
  suppliers             Supplier[]
  purchaseOrders        PurchaseOrder[]
  accounts              Account[]
  accountingPeriods     AccountingPeriod[]
  journalEntries        JournalEntry[]
  accountingConfig      AccountingConfig?
  bankAccounts          BankAccount[]
  bankStatements        BankStatement[]
  employees             Employee[]
  payrollPeriods        PayrollPeriod[]
  payrollEntries        PayrollEntry[]
  payrollConfig         PayrollConfig?

  @@map("tenants")
}

model User {
  id                       String        @id @default(cuid())
  tenantId                 String        @map("tenant_id")
  email                    String        @unique
  password                 String
  firstName                String        @map("first_name")
  lastName                 String        @map("last_name")
  phone                    String?
  avatar                   String?
  googleId                 String?       @unique @map("google_id")
  githubId                 String?       @unique @map("github_id")
  authProvider             AuthProvider  @default(EMAIL) @map("auth_provider")
  role                     UserRole      @default(EMPLOYEE)
  status                   UserStatus    @default(PENDING)
  emailVerified            Boolean       @default(false) @map("email_verified")
  verificationToken        String?       @unique @map("verification_token")
  verificationTokenExpiry  DateTime?     @map("verification_token_expiry")
  refreshToken             String?       @map("refresh_token")
  resetToken               String?       @map("reset_token")
  resetTokenExpiry         DateTime?     @map("reset_token_expiry")
  warehouseId              String?       @map("warehouse_id")
  approvedAt               DateTime?     @map("approved_at")
  approvedById             String?       @map("approved_by_id")
  createdAt                DateTime      @default(now()) @map("created_at")
  updatedAt                DateTime      @updatedAt @map("updated_at")
  lastLoginAt              DateTime?     @map("last_login_at")

  tenant              Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouse           Warehouse?               @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  invoices            Invoice[]
  movements           StockMovement[]
  auditLogs           AuditLog[]
  invitations         Invitation[]
  notifications       Notification[]
  posSessions         POSSession[]
  permissionOverrides UserPermissionOverride[]
  quotations          Quotation[]
  purchaseOrders      PurchaseOrder[]

  @@index([tenantId])
  @@index([warehouseId])
  @@map("users")
}

model UserPermissionOverride {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  tenantId   String   @map("tenant_id")
  permission String // e.g., "pos:refund", "inventory:adjust"
  granted    Boolean  @default(true) // true = grant permission, false = revoke permission
  grantedBy  String?  @map("granted_by") // User ID who granted this override
  reason     String? // Optional reason for audit trail
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@index([tenantId])
  @@index([userId])
  @@map("user_permission_overrides")
}

model Category {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  color       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("categories")
}

model Product {
  id          String        @id @default(cuid())
  tenantId    String        @map("tenant_id")
  categoryId  String?       @map("category_id")
  sku         String
  name        String
  description String?
  costPrice   Decimal       @default(0) @map("cost_price") @db.Decimal(10, 2)
  salePrice   Decimal       @default(0) @map("sale_price") @db.Decimal(10, 2)
  taxRate     Decimal       @default(19) @map("tax_rate") @db.Decimal(5, 2)
  taxCategory TaxCategory   @default(GRAVADO_19) @map("tax_category")
  stock       Int           @default(0)
  minStock    Int           @default(0) @map("min_stock")
  maxStock    Int?          @map("max_stock")
  barcode     String?
  brand       String?
  unit        String        @default("unit")
  imageUrl    String?       @map("image_url")
  status      ProductStatus @default(ACTIVE)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category       Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  invoiceItems       InvoiceItem[]
  quotationItems     QuotationItem[]
  purchaseOrderItems PurchaseOrderItem[]
  movements          StockMovement[]
  warehouseStock     WarehouseStock[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, categoryId])
  @@index([tenantId, barcode])
  @@index([tenantId, name])
  @@map("products")
}

model Warehouse {
  id        String          @id @default(cuid())
  tenantId  String          @map("tenant_id")
  name      String
  code      String
  address   String?
  city      String?
  phone     String?
  isMain    Boolean         @default(false) @map("is_main")
  status    WarehouseStatus @default(ACTIVE)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users          User[]
  invoices       Invoice[]
  invitations    Invitation[]
  stocks         WarehouseStock[]
  movements      StockMovement[]
  cashRegisters  CashRegister[]
  purchaseOrders PurchaseOrder[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("warehouses")
}

model WarehouseStock {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  warehouseId String   @map("warehouse_id")
  productId   String   @map("product_id")
  quantity    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, productId])
  @@index([tenantId])
  @@index([productId])
  @@map("warehouse_stocks")
}

model StockMovement {
  id          String       @id @default(cuid())
  tenantId    String       @map("tenant_id")
  productId   String       @map("product_id")
  warehouseId String?      @map("warehouse_id")
  userId      String?      @map("user_id")
  type            MovementType
  quantity        Int
  reason          String?
  notes           String?
  invoiceId       String?      @map("invoice_id")
  purchaseOrderId String?      @map("purchase_order_id")
  createdAt       DateTime     @default(now()) @map("created_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse     Warehouse?     @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([productId])
  @@index([warehouseId])
  @@index([tenantId, createdAt])
  @@index([tenantId, type])
  @@index([invoiceId])
  @@index([purchaseOrderId])
  @@map("stock_movements")
}

model Customer {
  id             String         @id @default(cuid())
  tenantId       String         @map("tenant_id")
  name           String
  email          String?
  phone          String?
  documentType   DocumentType   @default(CC) @map("document_type")
  documentNumber String         @map("document_number")
  address        String?
  city           String?
  state          String?
  businessName   String?        @map("business_name")
  taxId          String?        @map("tax_id")
  notes          String?
  status         CustomerStatus @default(ACTIVE)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices   Invoice[]
  quotations Quotation[]

  @@unique([tenantId, documentNumber])
  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("customers")
}

model Invoice {
  id            String        @id @default(cuid())
  tenantId      String        @map("tenant_id")
  customerId    String?       @map("customer_id")
  userId        String?       @map("user_id")
  invoiceNumber String        @map("invoice_number")
  source        InvoiceSource @default(MANUAL)
  subtotal      Decimal       @default(0) @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @default(0) @db.Decimal(10, 2)
  issueDate     DateTime      @default(now()) @map("issue_date")
  dueDate       DateTime?     @map("due_date")
  status        InvoiceStatus @default(DRAFT)
  paymentStatus PaymentStatus @default(UNPAID) @map("payment_status")
  notes         String?
  warehouseId   String?       @map("warehouse_id")
  dianCufe      String?       @map("dian_cufe")
  dianXml       String?       @map("dian_xml")
  dianPdf       String?       @map("dian_pdf")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer      Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)
  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  warehouse     Warehouse?     @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  items                  InvoiceItem[]
  payments               Payment[]
  posSale                POSSale?
  dianDocuments          DianDocument[]
  convertedFromQuotation Quotation?

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([tenantId, status])
  @@index([tenantId, paymentStatus])
  @@index([tenantId, issueDate])
  @@index([tenantId, createdAt])
  @@index([tenantId, source])
  @@index([warehouseId])
  @@map("invoices")
}

model InvoiceItem {
  id        String   @id @default(cuid())
  invoiceId String   @map("invoice_id")
  productId String?  @map("product_id")
  quantity  Int      @default(1)
  unitPrice Decimal  @default(0) @map("unit_price") @db.Decimal(10, 2)
  taxRate     Decimal     @default(19) @map("tax_rate") @db.Decimal(5, 2)
  taxCategory TaxCategory @default(GRAVADO_19) @map("tax_category")
  discount    Decimal     @default(0) @db.Decimal(10, 2)
  subtotal    Decimal     @default(0) @db.Decimal(10, 2)
  tax         Decimal     @default(0) @db.Decimal(10, 2)
  total       Decimal     @default(0) @db.Decimal(10, 2)
  createdAt   DateTime    @default(now()) @map("created_at")

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@map("invoice_items")
}

model Payment {
  id          String        @id @default(cuid())
  tenantId    String        @map("tenant_id")
  invoiceId   String        @map("invoice_id")
  amount      Decimal       @db.Decimal(10, 2)
  method      PaymentMethod @default(CASH)
  reference   String?
  notes       String?
  paymentDate DateTime      @default(now()) @map("payment_date")
  createdAt   DateTime      @default(now()) @map("created_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([invoiceId])
  @@index([tenantId, paymentDate])
  @@index([tenantId, method])
  @@map("payments")
}

model AuditLog {
  id         String      @id @default(cuid())
  tenantId   String      @map("tenant_id")
  userId     String?     @map("user_id")
  action     AuditAction
  entityType String      @map("entity_type")
  entityId   String      @map("entity_id")
  oldValues  Json?       @map("old_values")
  newValues  Json?       @map("new_values")
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  metadata   Json?
  createdAt  DateTime    @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

model Invitation {
  id          String           @id @default(uuid())
  email       String
  tenantId    String           @map("tenant_id")
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role        UserRole         @default(EMPLOYEE)
  warehouseId String?          @map("warehouse_id")
  warehouse   Warehouse?       @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  token       String           @unique
  expiresAt   DateTime         @map("expires_at")
  invitedById String           @map("invited_by_id")
  invitedBy   User             @relation(fields: [invitedById], references: [id])
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime         @default(now()) @map("created_at")
  acceptedAt  DateTime?        @map("accepted_at")

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([token])
  @@index([status])
  @@map("invitations")
}

model Notification {
  id        String               @id @default(cuid())
  tenantId  String               @map("tenant_id")
  userId    String?              @map("user_id")
  type      NotificationType
  title     String
  message   String
  priority  NotificationPriority @default(MEDIUM)
  read      Boolean              @default(false)
  readAt    DateTime?            @map("read_at")
  link      String?
  metadata  Json?
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, read])
  @@index([tenantId, userId])
  @@index([tenantId, type])
  @@index([tenantId, createdAt])
  @@map("notifications")
}

// ============================================================================
// SUBSCRIPTION MODEL
// ============================================================================

model Subscription {
  id              String             @id @default(cuid())
  tenantId        String             @unique @map("tenant_id")
  plan            SubscriptionPlan
  status          SubscriptionStatus @default(ACTIVE)
  startDate       DateTime           @default(now()) @map("start_date")
  endDate         DateTime           @map("end_date")
  periodType      SubscriptionPeriod @map("period_type")
  activatedById   String?            @map("activated_by_id")
  suspendedAt     DateTime?          @map("suspended_at")
  suspendedReason String?            @map("suspended_reason")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  billingTransactions BillingTransaction[]

  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

// ============================================================================
// BILLING TRANSACTION MODEL
// ============================================================================

model BillingTransaction {
  id                 String             @id @default(cuid())
  tenantId           String             @map("tenant_id")
  subscriptionId     String?            @map("subscription_id")
  wompiTransactionId String?            @unique @map("wompi_transaction_id")
  wompiReference     String?            @map("wompi_reference")
  plan               SubscriptionPlan
  period             SubscriptionPeriod
  amountInCents      Int                @map("amount_in_cents")
  currency           String             @default("COP")
  status             BillingStatus      @default(PENDING)
  paymentMethodType  String?            @map("payment_method_type")
  failureReason      String?            @map("failure_reason")
  isRecurring        Boolean            @default(false) @map("is_recurring")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([wompiTransactionId])
  @@index([status])
  @@index([tenantId, createdAt])
  @@map("billing_transactions")
}

// ============================================================================
// SYSTEM ADMIN MODELS (Separate from tenant users)
// ============================================================================

model SystemAdmin {
  id           String            @id @default(cuid())
  email        String            @unique
  password     String
  firstName    String            @map("first_name")
  lastName     String            @map("last_name")
  role         SystemAdminRole   @default(SUPPORT)
  status       SystemAdminStatus @default(ACTIVE)
  refreshToken String?           @map("refresh_token")
  lastLoginAt  DateTime?         @map("last_login_at")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  auditLogs SystemAdminAuditLog[]

  @@index([email])
  @@index([status])
  @@map("system_admins")
}

model SystemAdminAuditLog {
  id         String   @id @default(cuid())
  adminId    String   @map("admin_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  admin SystemAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("system_admin_audit_logs")
}

// ============================================================================
// POS MODELS
// ============================================================================

model CashRegister {
  id          String             @id @default(cuid())
  tenantId    String             @map("tenant_id")
  warehouseId String             @map("warehouse_id")
  name        String
  code        String
  status      CashRegisterStatus @default(CLOSED)
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  tenant    Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouse Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  sessions  POSSession[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([warehouseId])
  @@map("cash_registers")
}

model POSSession {
  id              String           @id @default(cuid())
  tenantId        String           @map("tenant_id")
  cashRegisterId  String           @map("cash_register_id")
  userId          String           @map("user_id")
  status          POSSessionStatus @default(ACTIVE)
  openingAmount   Decimal          @map("opening_amount") @db.Decimal(10, 2)
  closingAmount   Decimal?         @map("closing_amount") @db.Decimal(10, 2)
  expectedAmount  Decimal?         @map("expected_amount") @db.Decimal(10, 2)
  difference      Decimal?         @db.Decimal(10, 2)
  openedAt        DateTime         @default(now()) @map("opened_at")
  closedAt        DateTime?        @map("closed_at")
  notes           String?
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  tenant       Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashRegister CashRegister           @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  user         User                   @relation(fields: [userId], references: [id])
  movements    CashRegisterMovement[]
  sales        POSSale[]

  @@index([tenantId])
  @@index([cashRegisterId])
  @@index([userId])
  @@index([tenantId, status])
  @@index([tenantId, openedAt])
  @@map("pos_sessions")
}

model CashRegisterMovement {
  id        String           @id @default(cuid())
  tenantId  String           @map("tenant_id")
  sessionId String           @map("session_id")
  saleId    String?          @map("sale_id")
  type      CashMovementType
  amount    Decimal          @db.Decimal(10, 2)
  method    PaymentMethod?
  reference String?
  notes     String?
  createdAt DateTime         @default(now()) @map("created_at")

  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session POSSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sale    POSSale?   @relation(fields: [saleId], references: [id])

  @@index([tenantId])
  @@index([sessionId])
  @@index([saleId])
  @@index([tenantId, createdAt])
  @@map("cash_register_movements")
}

model POSSale {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  sessionId  String   @map("session_id")
  invoiceId  String   @unique @map("invoice_id")
  saleNumber String   @map("sale_number")
  subtotal   Decimal  @db.Decimal(10, 2)
  tax        Decimal  @db.Decimal(10, 2)
  discount   Decimal  @default(0) @db.Decimal(10, 2)
  total      Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now()) @map("created_at")

  tenant    Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session   POSSession             @relation(fields: [sessionId], references: [id])
  invoice   Invoice                @relation(fields: [invoiceId], references: [id])
  payments  SalePayment[]
  movements CashRegisterMovement[]

  @@unique([tenantId, saleNumber])
  @@index([tenantId])
  @@index([sessionId])
  @@index([tenantId, createdAt])
  @@map("pos_sales")
}

model SalePayment {
  id           String        @id @default(cuid())
  saleId       String        @map("sale_id")
  method       PaymentMethod
  amount       Decimal       @db.Decimal(10, 2)
  reference    String?
  cardLastFour String?       @map("card_last_four")
  createdAt    DateTime      @default(now()) @map("created_at")

  sale POSSale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@map("sale_payments")
}

// ============================================================================
// DIAN ELECTRONIC INVOICING MODELS
// ============================================================================

model TenantDianConfig {
  id                  String              @id @default(cuid())
  tenantId            String              @unique @map("tenant_id")
  nit                 String
  dv                  String // Digito de verificacion
  businessName        String              @map("business_name")
  tradeName           String?             @map("trade_name")
  taxResponsibilities TaxResponsibility[] @map("tax_responsibilities")
  economicActivity    String              @map("economic_activity")
  address             String
  city                String
  cityCode            String              @map("city_code")
  department          String
  departmentCode      String              @map("department_code")
  country             String              @default("CO")
  countryCode         String              @default("CO") @map("country_code")
  postalCode          String?             @map("postal_code")
  phone               String?
  email               String
  testMode            Boolean             @default(true) @map("test_mode")
  softwareId          String?             @map("software_id")
  softwarePin         String?             @map("software_pin")
  technicalKey        String?             @map("technical_key")
  certificateFile     Bytes?              @map("certificate_file")
  certificatePassword String?             @map("certificate_password")
  resolutionNumber    String?             @map("resolution_number")
  resolutionDate      DateTime?           @map("resolution_date")
  resolutionPrefix    String?             @map("resolution_prefix")
  resolutionRangeFrom Int?                @map("resolution_range_from")
  resolutionRangeTo   Int?                @map("resolution_range_to")
  currentNumber              Int                 @default(1) @map("current_number")
  creditNotePrefix           String?             @map("credit_note_prefix")
  creditNoteCurrentNumber    Int                 @default(1) @map("credit_note_current_number")
  debitNotePrefix            String?             @map("debit_note_prefix")
  debitNoteCurrentNumber     Int                 @default(1) @map("debit_note_current_number")
  createdAt                  DateTime            @default(now()) @map("created_at")
  updatedAt                  DateTime            @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_dian_configs")
}

model DianDocument {
  id                     String             @id @default(cuid())
  tenantId               String             @map("tenant_id")
  invoiceId              String?            @map("invoice_id")
  originalDianDocumentId String?            @map("original_dian_document_id")
  documentType           DianDocumentType   @map("document_type")
  documentNumber         String             @map("document_number")
  cufe                   String?            @unique
  cude                   String?            @unique // Para notas credito/debito
  creditNoteReason       String?            @map("credit_note_reason") @db.Text
  qrCode                 String?            @map("qr_code") @db.Text
  status                 DianDocumentStatus @default(PENDING)
  xmlContent             String?            @map("xml_content") @db.Text
  signedXml              String?            @map("signed_xml") @db.Text
  pdfContent             Bytes?             @map("pdf_content")
  dianResponse           Json?              @map("dian_response")
  dianTrackId            String?            @map("dian_track_id")
  errorMessage           String?            @map("error_message") @db.Text
  sentAt                 DateTime?          @map("sent_at")
  acceptedAt             DateTime?          @map("accepted_at")
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")

  tenant               Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice              Invoice?      @relation(fields: [invoiceId], references: [id])
  originalDianDocument DianDocument? @relation("NoteToOriginal", fields: [originalDianDocumentId], references: [id])
  relatedNotes         DianDocument[] @relation("NoteToOriginal")

  @@index([tenantId])
  @@index([cufe])
  @@index([status])
  @@index([tenantId, documentType])
  @@index([tenantId, createdAt])
  @@map("dian_documents")
}

// ============================
// Accounting Enums
// ============================

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
  COGS
}

enum AccountNature {
  DEBIT
  CREDIT
}

enum JournalEntryStatus {
  DRAFT
  POSTED
  VOIDED
}

enum JournalEntrySource {
  MANUAL
  INVOICE_SALE
  INVOICE_CANCEL
  PAYMENT_RECEIVED
  PURCHASE_RECEIVED
  STOCK_ADJUSTMENT
  PERIOD_CLOSE
  PAYROLL_APPROVED
  PAYROLL_ADJUSTMENT
}

enum AccountingPeriodStatus {
  OPEN
  CLOSING
  CLOSED
}

enum BankAccountType {
  CHECKING
  SAVINGS
}

enum BankStatementStatus {
  IMPORTED
  PARTIALLY_RECONCILED
  RECONCILED
}

enum ReconciliationStatus {
  MATCHED
  UNMATCHED
  MANUALLY_MATCHED
}

// ============================
// Purchases
// ============================

enum PurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  RECEIVED
  CANCELLED
}

enum PaymentTerms {
  IMMEDIATE
  NET_15
  NET_30
  NET_60
}

// ============================
// Quotations
// ============================

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

model Quotation {
  id                   String          @id @default(cuid())
  tenantId             String          @map("tenant_id")
  customerId           String?         @map("customer_id")
  userId               String?         @map("user_id")
  quotationNumber      String          @map("quotation_number")
  subtotal             Decimal         @default(0) @db.Decimal(10, 2)
  tax                  Decimal         @default(0) @db.Decimal(10, 2)
  discount             Decimal         @default(0) @db.Decimal(10, 2)
  total                Decimal         @default(0) @db.Decimal(10, 2)
  issueDate            DateTime        @default(now()) @map("issue_date")
  validUntil           DateTime?       @map("valid_until")
  status               QuotationStatus @default(DRAFT)
  notes                String?
  convertedToInvoiceId String?         @unique @map("converted_to_invoice_id")
  convertedAt          DateTime?       @map("converted_at")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  tenant             Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer           Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  user               User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  convertedToInvoice Invoice?      @relation(fields: [convertedToInvoiceId], references: [id], onDelete: SetNull)
  items              QuotationItem[]

  @@unique([tenantId, quotationNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("quotations")
}

model QuotationItem {
  id          String      @id @default(cuid())
  quotationId String      @map("quotation_id")
  productId   String?     @map("product_id")
  quantity    Int         @default(1)
  unitPrice   Decimal     @default(0) @map("unit_price") @db.Decimal(10, 2)
  taxRate     Decimal     @default(19) @map("tax_rate") @db.Decimal(5, 2)
  taxCategory TaxCategory @default(GRAVADO_19) @map("tax_category")
  discount    Decimal     @default(0) @db.Decimal(10, 2)
  subtotal    Decimal     @default(0) @db.Decimal(10, 2)
  tax         Decimal     @default(0) @db.Decimal(10, 2)
  total       Decimal     @default(0) @db.Decimal(10, 2)
  createdAt   DateTime    @default(now()) @map("created_at")

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product   Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([quotationId])
  @@map("quotation_items")
}

// ============================
// Suppliers & Purchase Orders
// ============================

model Supplier {
  id             String         @id @default(cuid())
  tenantId       String         @map("tenant_id")
  name           String
  email          String?
  phone          String?
  documentType   DocumentType   @default(NIT) @map("document_type")
  documentNumber String         @map("document_number")
  address        String?
  city           String?
  state          String?
  businessName   String?        @map("business_name")
  taxId          String?        @map("tax_id")
  notes          String?
  status         CustomerStatus @default(ACTIVE)
  paymentTerms   PaymentTerms   @default(NET_30) @map("payment_terms")
  contactName    String?        @map("contact_name")
  contactPhone   String?        @map("contact_phone")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@unique([tenantId, documentNumber])
  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("suppliers")
}

model PurchaseOrder {
  id                   String              @id @default(cuid())
  tenantId             String              @map("tenant_id")
  purchaseOrderNumber  String              @map("purchase_order_number")
  supplierId           String              @map("supplier_id")
  userId               String?             @map("user_id")
  warehouseId          String              @map("warehouse_id")
  status               PurchaseOrderStatus @default(DRAFT)
  paymentStatus        PaymentStatus       @default(UNPAID) @map("payment_status")
  subtotal             Decimal             @default(0) @db.Decimal(12, 2)
  tax                  Decimal             @default(0) @db.Decimal(12, 2)
  discount             Decimal             @default(0) @db.Decimal(12, 2)
  total                Decimal             @default(0) @db.Decimal(12, 2)
  issueDate            DateTime            @default(now()) @map("issue_date")
  expectedDeliveryDate DateTime?           @map("expected_delivery_date")
  receivedDate         DateTime?           @map("received_date")
  notes                String?
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")

  tenant    Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier  Supplier            @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  user      User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  warehouse Warehouse           @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  items     PurchaseOrderItem[]
  movements StockMovement[]

  @@unique([tenantId, purchaseOrderNumber])
  @@index([tenantId])
  @@index([supplierId])
  @@index([warehouseId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String      @id @default(cuid())
  purchaseOrderId String      @map("purchase_order_id")
  productId       String      @map("product_id")
  quantity        Int         @default(1)
  unitPrice       Decimal     @default(0) @map("unit_price") @db.Decimal(12, 2)
  taxRate         Decimal     @default(19) @map("tax_rate") @db.Decimal(5, 2)
  taxCategory     TaxCategory @default(GRAVADO_19) @map("tax_category")
  discount        Decimal     @default(0) @db.Decimal(12, 2)
  subtotal        Decimal     @default(0) @db.Decimal(12, 2)
  tax             Decimal     @default(0) @db.Decimal(12, 2)
  total           Decimal     @default(0) @db.Decimal(12, 2)
  createdAt       DateTime    @default(now()) @map("created_at")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

// ============================
// Accounting Models
// ============================

model Account {
  id              String        @id @default(cuid())
  tenantId        String        @map("tenant_id")
  code            String
  name            String
  description     String?
  type            AccountType
  nature          AccountNature
  parentId        String?       @map("parent_id")
  level           Int           @default(1)
  isActive        Boolean       @default(true) @map("is_active")
  isSystemAccount Boolean       @default(false) @map("is_system_account")
  isBankAccount   Boolean       @default(false) @map("is_bank_account")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent            Account?           @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children          Account[]          @relation("AccountHierarchy")
  journalEntryLines JournalEntryLine[]
  bankAccount       BankAccount?

  // AccountingConfig relations
  configCash               AccountingConfig[] @relation("CashAccount")
  configBank               AccountingConfig[] @relation("BankAccount")
  configAccountsReceivable AccountingConfig[] @relation("AccountsReceivableAccount")
  configInventory          AccountingConfig[] @relation("InventoryAccount")
  configAccountsPayable    AccountingConfig[] @relation("AccountsPayableAccount")
  configIvaPorPagar        AccountingConfig[] @relation("IvaPorPagarAccount")
  configIvaDescontable     AccountingConfig[] @relation("IvaDescontableAccount")
  configRevenue            AccountingConfig[] @relation("RevenueAccount")
  configCogs               AccountingConfig[] @relation("CogsAccount")
  configInventoryAdj       AccountingConfig[] @relation("InventoryAdjustmentAccount")
  configReteFuenteReceived AccountingConfig[] @relation("ReteFuenteReceivedAccount")
  configReteFuentePayable  AccountingConfig[] @relation("ReteFuentePayableAccount")
  configPayrollExpense     AccountingConfig[] @relation("PayrollExpenseAccount")
  configPayrollPayable     AccountingConfig[] @relation("PayrollPayableAccount")
  configPayrollRetentions  AccountingConfig[] @relation("PayrollRetentionsAccount")
  configPayrollContributions AccountingConfig[] @relation("PayrollContributionsAccount")
  configPayrollProvisions  AccountingConfig[] @relation("PayrollProvisionsAccount")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, parentId])
  @@index([tenantId, isActive])
  @@map("accounts")
}

model AccountingPeriod {
  id        String                 @id @default(cuid())
  tenantId  String                 @map("tenant_id")
  name      String
  startDate DateTime               @map("start_date")
  endDate   DateTime               @map("end_date")
  status    AccountingPeriodStatus @default(OPEN)
  closedAt  DateTime?              @map("closed_at")
  closedById String?               @map("closed_by_id")
  notes     String?
  createdAt DateTime               @default(now()) @map("created_at")
  updatedAt DateTime               @updatedAt @map("updated_at")

  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  journalEntries JournalEntry[]

  @@unique([tenantId, startDate, endDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("accounting_periods")
}

model JournalEntry {
  id              String             @id @default(cuid())
  tenantId        String             @map("tenant_id")
  periodId        String?            @map("period_id")
  entryNumber     String             @map("entry_number")
  date            DateTime
  description     String
  source          JournalEntrySource
  status          JournalEntryStatus @default(DRAFT)
  invoiceId       String?            @map("invoice_id")
  paymentId       String?            @map("payment_id")
  purchaseOrderId String?            @map("purchase_order_id")
  stockMovementId String?            @map("stock_movement_id")
  totalDebit      Decimal            @default(0) @map("total_debit") @db.Decimal(12, 2)
  totalCredit     Decimal            @default(0) @map("total_credit") @db.Decimal(12, 2)
  createdById     String?            @map("created_by_id")
  postedAt        DateTime?          @map("posted_at")
  voidedAt        DateTime?          @map("voided_at")
  voidReason      String?            @map("void_reason")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  tenant                   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  period                   AccountingPeriod?  @relation(fields: [periodId], references: [id], onDelete: SetNull)
  lines                    JournalEntryLine[]
  matchedBankStatementLines BankStatementLine[] @relation("MatchedJournalEntry")

  @@unique([tenantId, entryNumber])
  @@index([tenantId])
  @@index([tenantId, date])
  @@index([tenantId, source])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([invoiceId])
  @@index([paymentId])
  @@index([purchaseOrderId])
  @@index([stockMovementId])
  @@map("journal_entries")
}

model JournalEntryLine {
  id             String  @id @default(cuid())
  journalEntryId String  @map("journal_entry_id")
  accountId      String  @map("account_id")
  description    String?
  debit          Decimal @default(0) @db.Decimal(12, 2)
  credit         Decimal @default(0) @db.Decimal(12, 2)

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id], onDelete: Restrict)

  @@index([journalEntryId])
  @@index([accountId])
  @@map("journal_entry_lines")
}

model AccountingConfig {
  id                      String  @id @default(cuid())
  tenantId                String  @unique @map("tenant_id")
  cashAccountId           String? @map("cash_account_id")
  bankAccountId           String? @map("bank_account_id")
  accountsReceivableId    String? @map("accounts_receivable_id")
  inventoryAccountId      String? @map("inventory_account_id")
  accountsPayableId       String? @map("accounts_payable_id")
  ivaPorPagarId           String? @map("iva_por_pagar_id")
  ivaDescontableId        String? @map("iva_descontable_id")
  revenueAccountId        String? @map("revenue_account_id")
  cogsAccountId           String? @map("cogs_account_id")
  inventoryAdjustmentId   String? @map("inventory_adjustment_id")
  reteFuenteReceivedId    String? @map("rete_fuente_received_id")
  reteFuentePayableId     String? @map("rete_fuente_payable_id")
  payrollExpenseId        String? @map("payroll_expense_id")
  payrollPayableId        String? @map("payroll_payable_id")
  payrollRetentionsId     String? @map("payroll_retentions_id")
  payrollContributionsId  String? @map("payroll_contributions_id")
  payrollProvisionsId     String? @map("payroll_provisions_id")
  autoGenerateEntries     Boolean @default(false) @map("auto_generate_entries")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashAccount           Account? @relation("CashAccount", fields: [cashAccountId], references: [id], onDelete: SetNull)
  bankAccount           Account? @relation("BankAccount", fields: [bankAccountId], references: [id], onDelete: SetNull)
  accountsReceivable    Account? @relation("AccountsReceivableAccount", fields: [accountsReceivableId], references: [id], onDelete: SetNull)
  inventoryAccount      Account? @relation("InventoryAccount", fields: [inventoryAccountId], references: [id], onDelete: SetNull)
  accountsPayable       Account? @relation("AccountsPayableAccount", fields: [accountsPayableId], references: [id], onDelete: SetNull)
  ivaPorPagar           Account? @relation("IvaPorPagarAccount", fields: [ivaPorPagarId], references: [id], onDelete: SetNull)
  ivaDescontable        Account? @relation("IvaDescontableAccount", fields: [ivaDescontableId], references: [id], onDelete: SetNull)
  revenueAccount        Account? @relation("RevenueAccount", fields: [revenueAccountId], references: [id], onDelete: SetNull)
  cogsAccount           Account? @relation("CogsAccount", fields: [cogsAccountId], references: [id], onDelete: SetNull)
  inventoryAdjustment   Account? @relation("InventoryAdjustmentAccount", fields: [inventoryAdjustmentId], references: [id], onDelete: SetNull)
  reteFuenteReceived    Account? @relation("ReteFuenteReceivedAccount", fields: [reteFuenteReceivedId], references: [id], onDelete: SetNull)
  reteFuentePayable     Account? @relation("ReteFuentePayableAccount", fields: [reteFuentePayableId], references: [id], onDelete: SetNull)
  payrollExpense        Account? @relation("PayrollExpenseAccount", fields: [payrollExpenseId], references: [id], onDelete: SetNull)
  payrollPayable        Account? @relation("PayrollPayableAccount", fields: [payrollPayableId], references: [id], onDelete: SetNull)
  payrollRetentions     Account? @relation("PayrollRetentionsAccount", fields: [payrollRetentionsId], references: [id], onDelete: SetNull)
  payrollContributions  Account? @relation("PayrollContributionsAccount", fields: [payrollContributionsId], references: [id], onDelete: SetNull)
  payrollProvisions     Account? @relation("PayrollProvisionsAccount", fields: [payrollProvisionsId], references: [id], onDelete: SetNull)

  @@map("accounting_configs")
}

// ============================
// Banking Models
// ============================

model BankAccount {
  id             String          @id @default(cuid())
  tenantId       String          @map("tenant_id")
  accountId      String          @unique @map("account_id")
  name           String
  bankName       String          @map("bank_name")
  accountNumber  String          @map("account_number")
  accountType    BankAccountType @map("account_type")
  currency       String          @default("COP")
  initialBalance Decimal         @default(0) @map("initial_balance") @db.Decimal(12, 2)
  currentBalance Decimal         @default(0) @map("current_balance") @db.Decimal(12, 2)
  isActive       Boolean         @default(true) @map("is_active")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account    Account         @relation(fields: [accountId], references: [id], onDelete: Restrict)
  statements BankStatement[]

  @@unique([tenantId, accountNumber])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("bank_accounts")
}

model BankStatement {
  id            String              @id @default(cuid())
  tenantId      String              @map("tenant_id")
  bankAccountId String              @map("bank_account_id")
  fileName      String              @map("file_name")
  periodStart   DateTime            @map("period_start")
  periodEnd     DateTime            @map("period_end")
  status        BankStatementStatus @default(IMPORTED)
  totalLines    Int                 @default(0) @map("total_lines")
  matchedLines  Int                 @default(0) @map("matched_lines")
  importedAt    DateTime            @default(now()) @map("imported_at")
  importedById  String?             @map("imported_by_id")
  reconciledAt  DateTime?           @map("reconciled_at")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bankAccount BankAccount         @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  lines       BankStatementLine[]

  @@index([tenantId])
  @@index([bankAccountId])
  @@index([tenantId, status])
  @@map("bank_statements")
}

model BankStatementLine {
  id                    String               @id @default(cuid())
  statementId           String               @map("statement_id")
  lineDate              DateTime             @map("line_date")
  description           String
  reference             String?
  debit                 Decimal              @default(0) @db.Decimal(12, 2)
  credit                Decimal              @default(0) @db.Decimal(12, 2)
  balance               Decimal?             @db.Decimal(12, 2)
  status                ReconciliationStatus @default(UNMATCHED)
  matchedJournalEntryId String?              @map("matched_journal_entry_id")
  matchedPaymentId      String?              @map("matched_payment_id")
  matchedAt             DateTime?            @map("matched_at")
  matchedById           String?              @map("matched_by_id")

  statement           BankStatement @relation(fields: [statementId], references: [id], onDelete: Cascade)
  matchedJournalEntry JournalEntry? @relation("MatchedJournalEntry", fields: [matchedJournalEntryId], references: [id], onDelete: SetNull)

  @@index([statementId])
  @@index([matchedJournalEntryId])
  @@index([statementId, status])
  @@map("bank_statement_lines")
}

// ============================
// Payroll Models
// ============================

model Employee {
  id                String         @id @default(cuid())
  tenantId          String         @map("tenant_id")
  documentType      DocumentType   @default(CC) @map("document_type")
  documentNumber    String         @map("document_number")
  firstName         String         @map("first_name")
  lastName          String         @map("last_name")
  email             String?
  phone             String?
  address           String?
  city              String?
  cityCode          String?        @map("city_code")
  department        String?
  departmentCode    String?        @map("department_code")
  contractType      ContractType   @map("contract_type")
  salaryType        SalaryType     @default(ORDINARIO) @map("salary_type")
  baseSalary        Decimal        @map("base_salary") @db.Decimal(12, 2)
  auxilioTransporte Boolean        @default(false) @map("auxilio_transporte")
  arlRiskLevel      ARLRiskLevel   @default(LEVEL_I) @map("arl_risk_level")
  epsName           String?        @map("eps_name")
  epsCode           String?        @map("eps_code")
  afpName           String?        @map("afp_name")
  afpCode           String?        @map("afp_code")
  cajaName          String?        @map("caja_name")
  cajaCode          String?        @map("caja_code")
  bankName          String?        @map("bank_name")
  bankAccountType   String?        @map("bank_account_type")
  bankAccountNumber String?        @map("bank_account_number")
  costCenter        String?        @map("cost_center")
  startDate         DateTime       @map("start_date")
  endDate           DateTime?      @map("end_date")
  status            EmployeeStatus @default(ACTIVE)
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payrollEntries PayrollEntry[]

  @@unique([tenantId, documentNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, contractType])
  @@map("employees")
}

model PayrollPeriod {
  id               String              @id @default(cuid())
  tenantId         String              @map("tenant_id")
  name             String
  periodType       PayrollPeriodType   @map("period_type")
  startDate        DateTime            @map("start_date")
  endDate          DateTime            @map("end_date")
  paymentDate      DateTime?           @map("payment_date")
  status           PayrollPeriodStatus @default(OPEN)
  totalDevengados  Decimal             @default(0) @map("total_devengados") @db.Decimal(14, 2)
  totalDeducciones Decimal             @default(0) @map("total_deducciones") @db.Decimal(14, 2)
  totalNeto        Decimal             @default(0) @map("total_neto") @db.Decimal(14, 2)
  employeeCount    Int                 @default(0) @map("employee_count")
  approvedAt       DateTime?           @map("approved_at")
  approvedById     String?             @map("approved_by_id")
  notes            String?
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")

  tenant  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entries PayrollEntry[]

  @@unique([tenantId, startDate, endDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, startDate])
  @@map("payroll_periods")
}

model PayrollEntry {
  id                  String              @id @default(cuid())
  tenantId            String              @map("tenant_id")
  periodId            String              @map("period_id")
  employeeId          String              @map("employee_id")
  entryNumber         String              @map("entry_number")
  status              PayrollEntryStatus  @default(DRAFT)

  // Snapshot del empleado al momento del calculo
  baseSalary          Decimal             @map("base_salary") @db.Decimal(12, 2)
  salaryType          SalaryType          @map("salary_type")
  daysWorked          Int                 @default(30) @map("days_worked")

  // === Devengados ===
  sueldo              Decimal             @default(0) @db.Decimal(12, 2)
  auxilioTransporte   Decimal             @default(0) @map("auxilio_transporte") @db.Decimal(12, 2)
  horasExtras         Decimal             @default(0) @map("horas_extras") @db.Decimal(12, 2)
  bonificaciones      Decimal             @default(0) @db.Decimal(12, 2)
  comisiones          Decimal             @default(0) @db.Decimal(12, 2)
  viaticos            Decimal             @default(0) @db.Decimal(12, 2)
  incapacidad         Decimal             @default(0) @db.Decimal(12, 2)
  licencia            Decimal             @default(0) @db.Decimal(12, 2)
  vacaciones          Decimal             @default(0) @db.Decimal(12, 2)
  primaServicios      Decimal             @default(0) @map("prima_servicios") @db.Decimal(12, 2)
  cesantias           Decimal             @default(0) @db.Decimal(12, 2)
  interesesCesantias  Decimal             @default(0) @map("intereses_cesantias") @db.Decimal(12, 2)
  otrosDevengados     Decimal             @default(0) @map("otros_devengados") @db.Decimal(12, 2)
  totalDevengados     Decimal             @default(0) @map("total_devengados") @db.Decimal(14, 2)

  // === Deducciones ===
  saludEmpleado       Decimal             @default(0) @map("salud_empleado") @db.Decimal(12, 2)
  pensionEmpleado     Decimal             @default(0) @map("pension_empleado") @db.Decimal(12, 2)
  fondoSolidaridad    Decimal             @default(0) @map("fondo_solidaridad") @db.Decimal(12, 2)
  retencionFuente     Decimal             @default(0) @map("retencion_fuente") @db.Decimal(12, 2)
  sindicato           Decimal             @default(0) @db.Decimal(12, 2)
  libranzas           Decimal             @default(0) @db.Decimal(12, 2)
  otrasDeducciones    Decimal             @default(0) @map("otras_deducciones") @db.Decimal(12, 2)
  totalDeducciones    Decimal             @default(0) @map("total_deducciones") @db.Decimal(14, 2)

  // === Aportes Empleador (no se deducen del empleado) ===
  saludEmpleador      Decimal             @default(0) @map("salud_empleador") @db.Decimal(12, 2)
  pensionEmpleador    Decimal             @default(0) @map("pension_empleador") @db.Decimal(12, 2)
  arlEmpleador        Decimal             @default(0) @map("arl_empleador") @db.Decimal(12, 2)
  cajaEmpleador       Decimal             @default(0) @map("caja_empleador") @db.Decimal(12, 2)
  senaEmpleador       Decimal             @default(0) @map("sena_empleador") @db.Decimal(12, 2)
  icbfEmpleador       Decimal             @default(0) @map("icbf_empleador") @db.Decimal(12, 2)

  // === Provision Prestaciones ===
  provisionPrima      Decimal             @default(0) @map("provision_prima") @db.Decimal(12, 2)
  provisionCesantias  Decimal             @default(0) @map("provision_cesantias") @db.Decimal(12, 2)
  provisionIntereses  Decimal             @default(0) @map("provision_intereses") @db.Decimal(12, 2)
  provisionVacaciones Decimal             @default(0) @map("provision_vacaciones") @db.Decimal(12, 2)

  // === Neto ===
  totalNeto           Decimal             @default(0) @map("total_neto") @db.Decimal(14, 2)

  // === DIAN Nomina Electronica ===
  cune                String?             @unique
  dianDocumentType    PayrollDocumentType? @map("dian_document_type")
  dianStatus          DianDocumentStatus?  @map("dian_status")
  xmlContent          String?             @map("xml_content") @db.Text
  signedXml           String?             @map("signed_xml") @db.Text
  dianTrackId         String?             @map("dian_track_id")
  dianResponse        Json?               @map("dian_response")
  errorMessage        String?             @map("error_message") @db.Text
  sentAt              DateTime?           @map("sent_at")
  acceptedAt          DateTime?           @map("accepted_at")

  // Detalle horas extras como JSON
  overtimeDetails     Json?               @map("overtime_details")

  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  period            PayrollPeriod   @relation(fields: [periodId], references: [id], onDelete: Cascade)
  employee          Employee        @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  // Self-reference para notas de ajuste
  originalEntryId   String?         @map("original_entry_id")
  originalEntry     PayrollEntry?   @relation("PayrollAdjustment", fields: [originalEntryId], references: [id])
  adjustmentEntries PayrollEntry[]  @relation("PayrollAdjustment")

  @@unique([tenantId, entryNumber])
  @@index([tenantId])
  @@index([periodId])
  @@index([employeeId])
  @@index([tenantId, status])
  @@index([tenantId, dianStatus])
  @@map("payroll_entries")
}

model PayrollConfig {
  id                      String            @id @default(cuid())
  tenantId                String            @unique @map("tenant_id")

  // Parametros anuales (actualizar cada enero)
  smmlv                   Decimal           @default(1423500) @db.Decimal(12, 2)
  auxilioTransporteVal    Decimal           @default(200000) @map("auxilio_transporte_val") @db.Decimal(12, 2)
  uvtValue                Decimal           @default(49799) @map("uvt_value") @db.Decimal(12, 2)

  // Numeracion DIAN nomina
  payrollPrefix           String?           @map("payroll_prefix")
  payrollCurrentNumber    Int               @default(1) @map("payroll_current_number")
  adjustmentPrefix        String?           @map("adjustment_prefix")
  adjustmentCurrentNumber Int               @default(1) @map("adjustment_current_number")

  // Software DIAN para nomina (puede diferir del de facturacion)
  payrollSoftwareId       String?           @map("payroll_software_id")
  payrollSoftwarePin      String?           @map("payroll_software_pin")
  payrollTestSetId        String?           @map("payroll_test_set_id")

  defaultPeriodType       PayrollPeriodType @default(MONTHLY) @map("default_period_type")

  createdAt               DateTime          @default(now()) @map("created_at")
  updatedAt               DateTime          @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("payroll_configs")
}