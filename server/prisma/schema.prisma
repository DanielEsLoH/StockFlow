generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
  TRIAL
}

enum SubscriptionPlan {
  EMPRENDEDOR
  PYME
  PRO
  PLUS
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  CANCELLED
}

enum SubscriptionPeriod {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  EMPLOYEE
  CONTADOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum TaxCategory {
  GRAVADO_19
  GRAVADO_5
  EXENTO
  EXCLUIDO
}

enum WarehouseStatus {
  ACTIVE
  INACTIVE
}

enum MovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  RETURN
  DAMAGED
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

enum DocumentType {
  CC
  NIT
  RUT
  PASSPORT
  CE
  DNI
  OTHER
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  OVERDUE
  CANCELLED
  VOID
}

enum PaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  PSE
  NEQUI
  DAVIPLATA
  OTHER
}

enum InvoiceSource {
  MANUAL
  POS
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum SystemAdminRole {
  SUPER_ADMIN
  SUPPORT
  BILLING
}

enum SystemAdminStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum AuthProvider {
  EMAIL
  GOOGLE
  GITHUB
}

// POS Enums
enum CashRegisterStatus {
  OPEN
  CLOSED
  SUSPENDED
}

enum POSSessionStatus {
  ACTIVE
  CLOSED
  SUSPENDED
}

enum CashMovementType {
  OPENING
  CLOSING
  SALE
  REFUND
  CASH_IN
  CASH_OUT
}

// DIAN Enums
enum DianDocumentType {
  FACTURA_ELECTRONICA
  NOTA_CREDITO
  NOTA_DEBITO
}

enum DianDocumentStatus {
  PENDING
  GENERATED
  SIGNED
  SENT
  ACCEPTED
  REJECTED
  ERROR
}

enum TaxResponsibility {
  O_13 // Gran contribuyente
  O_15 // Autoretenedor
  O_23 // Agente de retencion IVA
  O_47 // Regimen simple
  R_99_PN // No responsable (persona natural)
}

enum BillingStatus {
  PENDING
  APPROVED
  DECLINED
  VOIDED
  ERROR
}

enum NotificationType {
  LOW_STOCK
  OUT_OF_STOCK
  NEW_INVOICE
  INVOICE_PAID
  INVOICE_OVERDUE
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  NEW_CUSTOMER
  REPORT_READY
  SYSTEM
  INFO
  USER_VERIFIED_EMAIL
  USER_APPROVED
  SUBSCRIPTION_EXPIRING
  SUBSCRIPTION_EXPIRED
  SUBSCRIPTION_ACTIVATED
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================================================
// MODELS
// ============================================================================

model Tenant {
  id                     String            @id @default(cuid())
  name                   String
  slug                   String            @unique
  email                  String
  phone                  String?
  status                 TenantStatus      @default(TRIAL)
  plan                   SubscriptionPlan?
  wompiPaymentSourceId   String?           @map("wompi_payment_source_id")
  wompiCustomerEmail     String?           @map("wompi_customer_email")
  maxUsers               Int               @default(1) @map("max_users")
  maxProducts            Int               @default(100) @map("max_products")
  maxInvoices            Int               @default(50) @map("max_invoices")
  maxWarehouses          Int               @default(1) @map("max_warehouses")
  createdAt              DateTime          @default(now()) @map("created_at")
  updatedAt              DateTime          @updatedAt @map("updated_at")

  users                 User[]
  products              Product[]
  customers             Customer[]
  invoices              Invoice[]
  warehouses            Warehouse[]
  categories            Category[]
  movements             StockMovement[]
  payments              Payment[]
  auditLogs             AuditLog[]
  invitations           Invitation[]
  notifications         Notification[]
  subscription          Subscription?
  cashRegisters         CashRegister[]
  posSessions           POSSession[]
  posSales              POSSale[]
  cashRegisterMovements CashRegisterMovement[]
  dianConfig            TenantDianConfig?
  dianDocuments         DianDocument[]
  billingTransactions   BillingTransaction[]
  quotations            Quotation[]
  suppliers             Supplier[]
  purchaseOrders        PurchaseOrder[]

  @@map("tenants")
}

model User {
  id                       String        @id @default(cuid())
  tenantId                 String        @map("tenant_id")
  email                    String        @unique
  password                 String
  firstName                String        @map("first_name")
  lastName                 String        @map("last_name")
  phone                    String?
  avatar                   String?
  googleId                 String?       @unique @map("google_id")
  githubId                 String?       @unique @map("github_id")
  authProvider             AuthProvider  @default(EMAIL) @map("auth_provider")
  role                     UserRole      @default(EMPLOYEE)
  status                   UserStatus    @default(PENDING)
  emailVerified            Boolean       @default(false) @map("email_verified")
  verificationToken        String?       @unique @map("verification_token")
  verificationTokenExpiry  DateTime?     @map("verification_token_expiry")
  refreshToken             String?       @map("refresh_token")
  resetToken               String?       @map("reset_token")
  resetTokenExpiry         DateTime?     @map("reset_token_expiry")
  warehouseId              String?       @map("warehouse_id")
  approvedAt               DateTime?     @map("approved_at")
  approvedById             String?       @map("approved_by_id")
  createdAt                DateTime      @default(now()) @map("created_at")
  updatedAt                DateTime      @updatedAt @map("updated_at")
  lastLoginAt              DateTime?     @map("last_login_at")

  tenant              Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouse           Warehouse?               @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  invoices            Invoice[]
  movements           StockMovement[]
  auditLogs           AuditLog[]
  invitations         Invitation[]
  notifications       Notification[]
  posSessions         POSSession[]
  permissionOverrides UserPermissionOverride[]
  quotations          Quotation[]
  purchaseOrders      PurchaseOrder[]

  @@index([tenantId])
  @@index([warehouseId])
  @@map("users")
}

model UserPermissionOverride {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  tenantId   String   @map("tenant_id")
  permission String // e.g., "pos:refund", "inventory:adjust"
  granted    Boolean  @default(true) // true = grant permission, false = revoke permission
  grantedBy  String?  @map("granted_by") // User ID who granted this override
  reason     String? // Optional reason for audit trail
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@index([tenantId])
  @@index([userId])
  @@map("user_permission_overrides")
}

model Category {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  color       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("categories")
}

model Product {
  id          String        @id @default(cuid())
  tenantId    String        @map("tenant_id")
  categoryId  String?       @map("category_id")
  sku         String
  name        String
  description String?
  costPrice   Decimal       @default(0) @map("cost_price") @db.Decimal(10, 2)
  salePrice   Decimal       @default(0) @map("sale_price") @db.Decimal(10, 2)
  taxRate     Decimal       @default(19) @map("tax_rate") @db.Decimal(5, 2)
  taxCategory TaxCategory   @default(GRAVADO_19) @map("tax_category")
  stock       Int           @default(0)
  minStock    Int           @default(0) @map("min_stock")
  maxStock    Int?          @map("max_stock")
  barcode     String?
  brand       String?
  unit        String        @default("unit")
  imageUrl    String?       @map("image_url")
  status      ProductStatus @default(ACTIVE)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category       Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  invoiceItems       InvoiceItem[]
  quotationItems     QuotationItem[]
  purchaseOrderItems PurchaseOrderItem[]
  movements          StockMovement[]
  warehouseStock     WarehouseStock[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, categoryId])
  @@index([tenantId, barcode])
  @@index([tenantId, name])
  @@map("products")
}

model Warehouse {
  id        String          @id @default(cuid())
  tenantId  String          @map("tenant_id")
  name      String
  code      String
  address   String?
  city      String?
  phone     String?
  isMain    Boolean         @default(false) @map("is_main")
  status    WarehouseStatus @default(ACTIVE)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users          User[]
  invoices       Invoice[]
  invitations    Invitation[]
  stocks         WarehouseStock[]
  movements      StockMovement[]
  cashRegisters  CashRegister[]
  purchaseOrders PurchaseOrder[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("warehouses")
}

model WarehouseStock {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  warehouseId String   @map("warehouse_id")
  productId   String   @map("product_id")
  quantity    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, productId])
  @@index([tenantId])
  @@index([productId])
  @@map("warehouse_stocks")
}

model StockMovement {
  id          String       @id @default(cuid())
  tenantId    String       @map("tenant_id")
  productId   String       @map("product_id")
  warehouseId String?      @map("warehouse_id")
  userId      String?      @map("user_id")
  type            MovementType
  quantity        Int
  reason          String?
  notes           String?
  invoiceId       String?      @map("invoice_id")
  purchaseOrderId String?      @map("purchase_order_id")
  createdAt       DateTime     @default(now()) @map("created_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse     Warehouse?     @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([productId])
  @@index([warehouseId])
  @@index([tenantId, createdAt])
  @@index([tenantId, type])
  @@index([invoiceId])
  @@index([purchaseOrderId])
  @@map("stock_movements")
}

model Customer {
  id             String         @id @default(cuid())
  tenantId       String         @map("tenant_id")
  name           String
  email          String?
  phone          String?
  documentType   DocumentType   @default(CC) @map("document_type")
  documentNumber String         @map("document_number")
  address        String?
  city           String?
  state          String?
  businessName   String?        @map("business_name")
  taxId          String?        @map("tax_id")
  notes          String?
  status         CustomerStatus @default(ACTIVE)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices   Invoice[]
  quotations Quotation[]

  @@unique([tenantId, documentNumber])
  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("customers")
}

model Invoice {
  id            String        @id @default(cuid())
  tenantId      String        @map("tenant_id")
  customerId    String?       @map("customer_id")
  userId        String?       @map("user_id")
  invoiceNumber String        @map("invoice_number")
  source        InvoiceSource @default(MANUAL)
  subtotal      Decimal       @default(0) @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @default(0) @db.Decimal(10, 2)
  issueDate     DateTime      @default(now()) @map("issue_date")
  dueDate       DateTime?     @map("due_date")
  status        InvoiceStatus @default(DRAFT)
  paymentStatus PaymentStatus @default(UNPAID) @map("payment_status")
  notes         String?
  warehouseId   String?       @map("warehouse_id")
  dianCufe      String?       @map("dian_cufe")
  dianXml       String?       @map("dian_xml")
  dianPdf       String?       @map("dian_pdf")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer      Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)
  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  warehouse     Warehouse?     @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  items                  InvoiceItem[]
  payments               Payment[]
  posSale                POSSale?
  dianDocuments          DianDocument[]
  convertedFromQuotation Quotation?

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([tenantId, status])
  @@index([tenantId, paymentStatus])
  @@index([tenantId, issueDate])
  @@index([tenantId, createdAt])
  @@index([tenantId, source])
  @@index([warehouseId])
  @@map("invoices")
}

model InvoiceItem {
  id        String   @id @default(cuid())
  invoiceId String   @map("invoice_id")
  productId String?  @map("product_id")
  quantity  Int      @default(1)
  unitPrice Decimal  @default(0) @map("unit_price") @db.Decimal(10, 2)
  taxRate     Decimal     @default(19) @map("tax_rate") @db.Decimal(5, 2)
  taxCategory TaxCategory @default(GRAVADO_19) @map("tax_category")
  discount    Decimal     @default(0) @db.Decimal(10, 2)
  subtotal    Decimal     @default(0) @db.Decimal(10, 2)
  tax         Decimal     @default(0) @db.Decimal(10, 2)
  total       Decimal     @default(0) @db.Decimal(10, 2)
  createdAt   DateTime    @default(now()) @map("created_at")

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@map("invoice_items")
}

model Payment {
  id          String        @id @default(cuid())
  tenantId    String        @map("tenant_id")
  invoiceId   String        @map("invoice_id")
  amount      Decimal       @db.Decimal(10, 2)
  method      PaymentMethod @default(CASH)
  reference   String?
  notes       String?
  paymentDate DateTime      @default(now()) @map("payment_date")
  createdAt   DateTime      @default(now()) @map("created_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([invoiceId])
  @@index([tenantId, paymentDate])
  @@index([tenantId, method])
  @@map("payments")
}

model AuditLog {
  id         String      @id @default(cuid())
  tenantId   String      @map("tenant_id")
  userId     String?     @map("user_id")
  action     AuditAction
  entityType String      @map("entity_type")
  entityId   String      @map("entity_id")
  oldValues  Json?       @map("old_values")
  newValues  Json?       @map("new_values")
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  metadata   Json?
  createdAt  DateTime    @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

model Invitation {
  id          String           @id @default(uuid())
  email       String
  tenantId    String           @map("tenant_id")
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role        UserRole         @default(EMPLOYEE)
  warehouseId String?          @map("warehouse_id")
  warehouse   Warehouse?       @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  token       String           @unique
  expiresAt   DateTime         @map("expires_at")
  invitedById String           @map("invited_by_id")
  invitedBy   User             @relation(fields: [invitedById], references: [id])
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime         @default(now()) @map("created_at")
  acceptedAt  DateTime?        @map("accepted_at")

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([token])
  @@index([status])
  @@map("invitations")
}

model Notification {
  id        String               @id @default(cuid())
  tenantId  String               @map("tenant_id")
  userId    String?              @map("user_id")
  type      NotificationType
  title     String
  message   String
  priority  NotificationPriority @default(MEDIUM)
  read      Boolean              @default(false)
  readAt    DateTime?            @map("read_at")
  link      String?
  metadata  Json?
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, read])
  @@index([tenantId, userId])
  @@index([tenantId, type])
  @@index([tenantId, createdAt])
  @@map("notifications")
}

// ============================================================================
// SUBSCRIPTION MODEL
// ============================================================================

model Subscription {
  id              String             @id @default(cuid())
  tenantId        String             @unique @map("tenant_id")
  plan            SubscriptionPlan
  status          SubscriptionStatus @default(ACTIVE)
  startDate       DateTime           @default(now()) @map("start_date")
  endDate         DateTime           @map("end_date")
  periodType      SubscriptionPeriod @map("period_type")
  activatedById   String?            @map("activated_by_id")
  suspendedAt     DateTime?          @map("suspended_at")
  suspendedReason String?            @map("suspended_reason")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  billingTransactions BillingTransaction[]

  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

// ============================================================================
// BILLING TRANSACTION MODEL
// ============================================================================

model BillingTransaction {
  id                 String             @id @default(cuid())
  tenantId           String             @map("tenant_id")
  subscriptionId     String?            @map("subscription_id")
  wompiTransactionId String?            @unique @map("wompi_transaction_id")
  wompiReference     String?            @map("wompi_reference")
  plan               SubscriptionPlan
  period             SubscriptionPeriod
  amountInCents      Int                @map("amount_in_cents")
  currency           String             @default("COP")
  status             BillingStatus      @default(PENDING)
  paymentMethodType  String?            @map("payment_method_type")
  failureReason      String?            @map("failure_reason")
  isRecurring        Boolean            @default(false) @map("is_recurring")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([wompiTransactionId])
  @@index([status])
  @@index([tenantId, createdAt])
  @@map("billing_transactions")
}

// ============================================================================
// SYSTEM ADMIN MODELS (Separate from tenant users)
// ============================================================================

model SystemAdmin {
  id           String            @id @default(cuid())
  email        String            @unique
  password     String
  firstName    String            @map("first_name")
  lastName     String            @map("last_name")
  role         SystemAdminRole   @default(SUPPORT)
  status       SystemAdminStatus @default(ACTIVE)
  refreshToken String?           @map("refresh_token")
  lastLoginAt  DateTime?         @map("last_login_at")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  auditLogs SystemAdminAuditLog[]

  @@index([email])
  @@index([status])
  @@map("system_admins")
}

model SystemAdminAuditLog {
  id         String   @id @default(cuid())
  adminId    String   @map("admin_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  admin SystemAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("system_admin_audit_logs")
}

// ============================================================================
// POS MODELS
// ============================================================================

model CashRegister {
  id          String             @id @default(cuid())
  tenantId    String             @map("tenant_id")
  warehouseId String             @map("warehouse_id")
  name        String
  code        String
  status      CashRegisterStatus @default(CLOSED)
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  tenant    Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouse Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  sessions  POSSession[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([warehouseId])
  @@map("cash_registers")
}

model POSSession {
  id              String           @id @default(cuid())
  tenantId        String           @map("tenant_id")
  cashRegisterId  String           @map("cash_register_id")
  userId          String           @map("user_id")
  status          POSSessionStatus @default(ACTIVE)
  openingAmount   Decimal          @map("opening_amount") @db.Decimal(10, 2)
  closingAmount   Decimal?         @map("closing_amount") @db.Decimal(10, 2)
  expectedAmount  Decimal?         @map("expected_amount") @db.Decimal(10, 2)
  difference      Decimal?         @db.Decimal(10, 2)
  openedAt        DateTime         @default(now()) @map("opened_at")
  closedAt        DateTime?        @map("closed_at")
  notes           String?
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  tenant       Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashRegister CashRegister           @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  user         User                   @relation(fields: [userId], references: [id])
  movements    CashRegisterMovement[]
  sales        POSSale[]

  @@index([tenantId])
  @@index([cashRegisterId])
  @@index([userId])
  @@index([tenantId, status])
  @@index([tenantId, openedAt])
  @@map("pos_sessions")
}

model CashRegisterMovement {
  id        String           @id @default(cuid())
  tenantId  String           @map("tenant_id")
  sessionId String           @map("session_id")
  saleId    String?          @map("sale_id")
  type      CashMovementType
  amount    Decimal          @db.Decimal(10, 2)
  method    PaymentMethod?
  reference String?
  notes     String?
  createdAt DateTime         @default(now()) @map("created_at")

  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session POSSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sale    POSSale?   @relation(fields: [saleId], references: [id])

  @@index([tenantId])
  @@index([sessionId])
  @@index([saleId])
  @@index([tenantId, createdAt])
  @@map("cash_register_movements")
}

model POSSale {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  sessionId  String   @map("session_id")
  invoiceId  String   @unique @map("invoice_id")
  saleNumber String   @map("sale_number")
  subtotal   Decimal  @db.Decimal(10, 2)
  tax        Decimal  @db.Decimal(10, 2)
  discount   Decimal  @default(0) @db.Decimal(10, 2)
  total      Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now()) @map("created_at")

  tenant    Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session   POSSession             @relation(fields: [sessionId], references: [id])
  invoice   Invoice                @relation(fields: [invoiceId], references: [id])
  payments  SalePayment[]
  movements CashRegisterMovement[]

  @@unique([tenantId, saleNumber])
  @@index([tenantId])
  @@index([sessionId])
  @@index([tenantId, createdAt])
  @@map("pos_sales")
}

model SalePayment {
  id           String        @id @default(cuid())
  saleId       String        @map("sale_id")
  method       PaymentMethod
  amount       Decimal       @db.Decimal(10, 2)
  reference    String?
  cardLastFour String?       @map("card_last_four")
  createdAt    DateTime      @default(now()) @map("created_at")

  sale POSSale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@map("sale_payments")
}

// ============================================================================
// DIAN ELECTRONIC INVOICING MODELS
// ============================================================================

model TenantDianConfig {
  id                  String              @id @default(cuid())
  tenantId            String              @unique @map("tenant_id")
  nit                 String
  dv                  String // Digito de verificacion
  businessName        String              @map("business_name")
  tradeName           String?             @map("trade_name")
  taxResponsibilities TaxResponsibility[] @map("tax_responsibilities")
  economicActivity    String              @map("economic_activity")
  address             String
  city                String
  cityCode            String              @map("city_code")
  department          String
  departmentCode      String              @map("department_code")
  country             String              @default("CO")
  countryCode         String              @default("CO") @map("country_code")
  postalCode          String?             @map("postal_code")
  phone               String?
  email               String
  testMode            Boolean             @default(true) @map("test_mode")
  softwareId          String?             @map("software_id")
  softwarePin         String?             @map("software_pin")
  technicalKey        String?             @map("technical_key")
  certificateFile     Bytes?              @map("certificate_file")
  certificatePassword String?             @map("certificate_password")
  resolutionNumber    String?             @map("resolution_number")
  resolutionDate      DateTime?           @map("resolution_date")
  resolutionPrefix    String?             @map("resolution_prefix")
  resolutionRangeFrom Int?                @map("resolution_range_from")
  resolutionRangeTo   Int?                @map("resolution_range_to")
  currentNumber       Int                 @default(1) @map("current_number")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_dian_configs")
}

model DianDocument {
  id             String             @id @default(cuid())
  tenantId       String             @map("tenant_id")
  invoiceId      String?            @map("invoice_id")
  documentType   DianDocumentType   @map("document_type")
  documentNumber String             @map("document_number")
  cufe           String?            @unique
  cude           String?            @unique // Para notas credito/debito
  qrCode         String?            @map("qr_code") @db.Text
  status         DianDocumentStatus @default(PENDING)
  xmlContent     String?            @map("xml_content") @db.Text
  signedXml      String?            @map("signed_xml") @db.Text
  pdfContent     Bytes?             @map("pdf_content")
  dianResponse   Json?              @map("dian_response")
  dianTrackId    String?            @map("dian_track_id")
  errorMessage   String?            @map("error_message") @db.Text
  sentAt         DateTime?          @map("sent_at")
  acceptedAt     DateTime?          @map("accepted_at")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@index([cufe])
  @@index([status])
  @@index([tenantId, documentType])
  @@index([tenantId, createdAt])
  @@map("dian_documents")
}

// ============================
// Purchases
// ============================

enum PurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  RECEIVED
  CANCELLED
}

enum PaymentTerms {
  IMMEDIATE
  NET_15
  NET_30
  NET_60
}

// ============================
// Quotations
// ============================

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

model Quotation {
  id                   String          @id @default(cuid())
  tenantId             String          @map("tenant_id")
  customerId           String?         @map("customer_id")
  userId               String?         @map("user_id")
  quotationNumber      String          @map("quotation_number")
  subtotal             Decimal         @default(0) @db.Decimal(10, 2)
  tax                  Decimal         @default(0) @db.Decimal(10, 2)
  discount             Decimal         @default(0) @db.Decimal(10, 2)
  total                Decimal         @default(0) @db.Decimal(10, 2)
  issueDate            DateTime        @default(now()) @map("issue_date")
  validUntil           DateTime?       @map("valid_until")
  status               QuotationStatus @default(DRAFT)
  notes                String?
  convertedToInvoiceId String?         @unique @map("converted_to_invoice_id")
  convertedAt          DateTime?       @map("converted_at")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  tenant             Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer           Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  user               User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  convertedToInvoice Invoice?      @relation(fields: [convertedToInvoiceId], references: [id], onDelete: SetNull)
  items              QuotationItem[]

  @@unique([tenantId, quotationNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("quotations")
}

model QuotationItem {
  id          String      @id @default(cuid())
  quotationId String      @map("quotation_id")
  productId   String?     @map("product_id")
  quantity    Int         @default(1)
  unitPrice   Decimal     @default(0) @map("unit_price") @db.Decimal(10, 2)
  taxRate     Decimal     @default(19) @map("tax_rate") @db.Decimal(5, 2)
  taxCategory TaxCategory @default(GRAVADO_19) @map("tax_category")
  discount    Decimal     @default(0) @db.Decimal(10, 2)
  subtotal    Decimal     @default(0) @db.Decimal(10, 2)
  tax         Decimal     @default(0) @db.Decimal(10, 2)
  total       Decimal     @default(0) @db.Decimal(10, 2)
  createdAt   DateTime    @default(now()) @map("created_at")

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product   Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([quotationId])
  @@map("quotation_items")
}

// ============================
// Suppliers & Purchase Orders
// ============================

model Supplier {
  id             String         @id @default(cuid())
  tenantId       String         @map("tenant_id")
  name           String
  email          String?
  phone          String?
  documentType   DocumentType   @default(NIT) @map("document_type")
  documentNumber String         @map("document_number")
  address        String?
  city           String?
  state          String?
  businessName   String?        @map("business_name")
  taxId          String?        @map("tax_id")
  notes          String?
  status         CustomerStatus @default(ACTIVE)
  paymentTerms   PaymentTerms   @default(NET_30) @map("payment_terms")
  contactName    String?        @map("contact_name")
  contactPhone   String?        @map("contact_phone")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@unique([tenantId, documentNumber])
  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("suppliers")
}

model PurchaseOrder {
  id                   String              @id @default(cuid())
  tenantId             String              @map("tenant_id")
  purchaseOrderNumber  String              @map("purchase_order_number")
  supplierId           String              @map("supplier_id")
  userId               String?             @map("user_id")
  warehouseId          String              @map("warehouse_id")
  status               PurchaseOrderStatus @default(DRAFT)
  paymentStatus        PaymentStatus       @default(UNPAID) @map("payment_status")
  subtotal             Decimal             @default(0) @db.Decimal(12, 2)
  tax                  Decimal             @default(0) @db.Decimal(12, 2)
  discount             Decimal             @default(0) @db.Decimal(12, 2)
  total                Decimal             @default(0) @db.Decimal(12, 2)
  issueDate            DateTime            @default(now()) @map("issue_date")
  expectedDeliveryDate DateTime?           @map("expected_delivery_date")
  receivedDate         DateTime?           @map("received_date")
  notes                String?
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")

  tenant    Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier  Supplier            @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  user      User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  warehouse Warehouse           @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  items     PurchaseOrderItem[]
  movements StockMovement[]

  @@unique([tenantId, purchaseOrderNumber])
  @@index([tenantId])
  @@index([supplierId])
  @@index([warehouseId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String      @id @default(cuid())
  purchaseOrderId String      @map("purchase_order_id")
  productId       String      @map("product_id")
  quantity        Int         @default(1)
  unitPrice       Decimal     @default(0) @map("unit_price") @db.Decimal(12, 2)
  taxRate         Decimal     @default(19) @map("tax_rate") @db.Decimal(5, 2)
  taxCategory     TaxCategory @default(GRAVADO_19) @map("tax_category")
  discount        Decimal     @default(0) @db.Decimal(12, 2)
  subtotal        Decimal     @default(0) @db.Decimal(12, 2)
  tax             Decimal     @default(0) @db.Decimal(12, 2)
  total           Decimal     @default(0) @db.Decimal(12, 2)
  createdAt       DateTime    @default(now()) @map("created_at")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}